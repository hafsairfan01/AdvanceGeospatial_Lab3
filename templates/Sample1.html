<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Calgary Building Permits (GeoJSON)</title>

  <!-- Leaflet CSS -->
  <link 
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- jQuery -->
  <script
    src="https://code.jquery.com/jquery-3.6.0.min.js">
  </script>

  <!-- Moment JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/moment@2.29.3/moment.min.js">
  </script>

  <!-- Date Range Picker CSS/JS -->
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.css"
  />
  <script 
    src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js">
  </script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <style>
    html, body {
      margin: 0; 
      padding: 0; 
      height: 100%;
      font-family: Arial, sans-serif;
    }
    h1 {
      text-align: center;
      margin: 20px;
    }
    #map {
      width: 100%;
      height: 80vh;
    }
    #controls {
      padding: 10px;
      background: #f2f2f2;
      text-align: center;
    }
    #issuedDateRange {
      width: 220px;
      margin-right: 10px;
    }
  </style>
</head>
<body>

<h1>Calgary Building Permits (GeoJSON)</h1>

<div id="controls">
  <label for="issuedDateRange">Issued Date Range:</label>
  <input type="text" id="issuedDateRange" />
  <button id="searchBtn">Search</button>
</div>

<div id="map"></div>

<script>
  $(function(){
    // 1) Initialize Leaflet map centered on Calgary
    const map = L.map('map').setView([51.0447, -114.0719], 11);

    // 2) Base tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    // Use a LayerGroup for adding/removing markers
    let markersLayer = L.layerGroup().addTo(map);

    // --- HARDCODE "today" as Dec 31, 2023 (or choose your own date) ---
    const fakeToday = moment('2023-12-31', 'YYYY-MM-DD');
    
    // End date is "yesterday" relative to fakeToday
    let endDate = fakeToday.clone().subtract(1, 'days'); 
    // Start date is 30 days before that
    let startDate = endDate.clone().subtract(30, 'days');

    $('#issuedDateRange').daterangepicker({
      autoApply: false,
      linkedCalendars: true,
      showDropdowns: true,
      startDate: startDate,
      endDate: endDate,
      // Restrict picking anything after Dec 30, 2023
      maxDate: fakeToday.clone().subtract(1, 'days'),
      locale: {
        format: 'YYYY-MM-DD'
      },
      ranges: {
        'Yesterday': [
          fakeToday.clone().subtract(1, 'days'), 
          fakeToday.clone().subtract(1, 'days')
        ],
        'Last 7 Days': [
          fakeToday.clone().subtract(7, 'days'), 
          fakeToday.clone().subtract(1, 'days')
        ],
        'Last 30 Days': [
          fakeToday.clone().subtract(30, 'days'), 
          fakeToday.clone().subtract(1, 'days')
        ],
        'This Month': [
          fakeToday.clone().startOf('month'), 
          fakeToday.clone().subtract(1, 'days')
        ]
      }
    }, function(start, end) {
      // Update variables when the user picks a new date
      startDate = start;
      endDate   = end;
      console.log("Selected: " + start.format('YYYY-MM-DD') + " - " + end.format('YYYY-MM-DD'));
    });

    // 4) On "Search", fetch building permits for the chosen date range
    $('#searchBtn').click(async () => {
      // Clear any existing markers
      markersLayer.clearLayers();

      // Build SoQL date filter
      const startString = startDate.format('YYYY-MM-DDT00:00:00.000');
      const endString   = endDate.format('YYYY-MM-DDT23:59:59.999');

      // *** Switch to the GeoJSON endpoint here ***
      const baseUrl = 'https://data.calgary.ca/resource/c2es-76ed.geojson';

      // We do not use $select in GeoJSON, because
      // we want the geometry to be returned in standard Feature form
      const params = [
        `$where=issueddate >= '${startString}' AND issueddate <= '${endString}'`,
        '$limit=2000'
      ];

      // Join the SoQL parameters into the query string
      const queryUrl = `${baseUrl}?${params.join('&')}`;
      console.log("Query URL:", queryUrl);

      try {
        const resp = await fetch(queryUrl);
        if (!resp.ok) throw new Error("Network error during fetch");
        
        // The data is a GeoJSON FeatureCollection
        const data = await resp.json();
        console.log("Fetched GeoJSON:", data);

        // data.features: array of GeoJSON Feature objects
        const features = data.features || [];
        const latLngs = [];

        features.forEach(feature => {
          // Each Feature has a geometry (Point, MultiPoint, etc.) and properties
          if (feature.geometry && feature.geometry.type === 'Point') {
            // For a Point geometry, coordinates = [lng, lat]
            const [lng, lat] = feature.geometry.coordinates;
            if (typeof lat === 'number' && typeof lng === 'number') {
              // We'll read some attributes from feature.properties
              const props = feature.properties || {};
              const marker = L.marker([lat, lng]);
              marker.bindPopup(`
                <strong>Issued Date:</strong> ${props.issueddate}<br/>
                <strong>Work Class:</strong> ${props.workclassgroup || 'N/A'}<br/>
                <strong>Contractor:</strong> ${props.contractorname || 'N/A'}<br/>
                <strong>Address:</strong> ${props.originaladdress || 'N/A'}<br/>
                <strong>Community:</strong> ${props.communityname || 'N/A'}<br/>
              `);
              marker.addTo(markersLayer);
              latLngs.push([lat, lng]);
            }
          }
        });

        // Zoom to markers
        if (latLngs.length > 0) {
          map.fitBounds(L.latLngBounds(latLngs), { padding: [50, 50] });
        } else {
          alert("No permits found in that date range!");
        }

      } catch (err) {
        alert("Failed to load data. Check console for details.");
        console.error(err);
      }
    });
  });
</script>

</body>
</html>
