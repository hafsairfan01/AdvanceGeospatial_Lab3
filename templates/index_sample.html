<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Calgary Building Permits (JSON)</title>

  <!-- Leaflet CSS -->
  <link 
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- jQuery (required by daterangepicker) -->
  <script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJ+7yX7en+2b6+zUl6Wd4tMz8u4J6GJPsZxXQ="
    crossorigin="anonymous">
  </script>

  <!-- Moment.js (required by daterangepicker) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/moment@2.29.3/moment.min.js">
  </script>

  <!-- Date Range Picker CSS -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.css"
  />

  <!-- Date Range Picker JS -->
  <script 
    src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js">
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    h1 {
      margin: 0;
      padding: 10px;
      background-color: #eee;
    }
    #controls {
      padding: 10px;
      background-color: #f2f2f2;
    }
    #map {
      width: 100%;
      height: 80vh; /* Enough space for the map */
      border: 1px solid #ccc; /* optional for seeing the container */
    }
  </style>
</head>
<body>
  <h1>Calgary Building Permits (JSON Endpoint)</h1>
  <div id="controls">
    <label for="dateRange">Select Date Range:</label>
    <input type="text" id="dateRange" />
    <button id="searchBtn">Search</button>
    <!-- For example, pick 06/22/1999 - 02/28/2025 -->
  </div>

  <div id="map"></div>

  <!-- Leaflet JS (load after the HTML but before our custom script) -->
  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <script>
    // Wrap all JS in a DOM-ready block so jQuery is available
    $(function() {
      // 1. Initialize the Leaflet map
      const map = L.map('map').setView([51.0447, -114.0719], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© OpenStreetMap contributors'
      }).addTo(map);

      // We'll store our markers in a LayerGroup so we can remove them on each search
      let markersLayerGroup = L.layerGroup().addTo(map);

      // 2. Initialize the date range picker
      const dateRangeInput = $('#dateRange');
      dateRangeInput.daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: 'YYYY-MM-DD'
        }
      }, function(start, end) {
        // Once user picks dates, update the input's value
        dateRangeInput.val(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
      });

      // 3. Handle search button
      $('#searchBtn').click(async () => {
        const rangeVal = dateRangeInput.val();
        if (!rangeVal) {
          alert("Please select a date range first!");
          return;
        }

        const [start, end] = rangeVal.split(" - ");
        if (!start || !end) {
          alert("Invalid date range format.");
          return;
        }

        // Construct the date/time filters
        const startDate = `${start}T00:00:00.000`;
        const endDate   = `${end}T23:59:59.999`;

        // 4. Build SoQL query
        const baseUrl = "https://data.calgary.ca/resource/c2es-76ed.json";
        const params = [
          `$where=issueddate >= '${startDate}' AND issueddate <= '${endDate}'`,
          "$limit=2000",
          "$select=issueddate,workclassgroup,contractorname,communityname,originaladdress,location,description"
        ];
        const queryUrl = `${baseUrl}?${params.join("&")}`;
        console.log("Query URL:", queryUrl);

        try {
          const response = await fetch(queryUrl);
          if (!response.ok) {
            throw new Error("Network response was not OK");
          }
          const data = await response.json();

          // Remove old markers
          markersLayerGroup.clearLayers();

          const latLngs = [];

          data.forEach(permit => {
            // location is typically { "type": "Point", "coordinates": [lng, lat] }
            if (permit.location && permit.location.coordinates) {
              const [lng, lat] = permit.location.coordinates;
              // Make sure lat/lng are valid numbers
              if (typeof lat === 'number' && typeof lng === 'number') {
                const marker = L.marker([lat, lng]);
                marker.bindPopup(`
                  <strong>Issued Date:</strong> ${permit.issueddate || "N/A"}<br/>
                  <strong>Work Class:</strong> ${permit.workclassgroup || "N/A"}<br/>
                  <strong>Contractor:</strong> ${permit.contractorname || "N/A"}<br/>
                  <strong>Address:</strong> ${permit.originaladdress || "N/A"}<br/>
                  <strong>Community:</strong> ${permit.communityname || "N/A"}<br/>
                  <strong>Description:</strong> ${permit.description || "N/A"}
                `);
                marker.addTo(markersLayerGroup);
                latLngs.push([lat, lng]);
              }
            }
          });

          // Fit map to the markers if any
          if (latLngs.length > 0) {
            const bounds = L.latLngBounds(latLngs);
            map.fitBounds(bounds, { padding: [50, 50] });
          } else {
            alert("No building permits found for the selected date range.");
          }
        } catch (error) {
          console.error("Fetch error:", error);
          alert("Failed to fetch data. Check console for details.");
        }
      });
    });
  </script>
</body>
</html>
